# EfieldInterpolation
This repository provides code for rapid E-field interpolation, which can be integrated in software e.g. for automated TMS stimulator adjustments based on motion tracking. 
The methodology comprises of two steps:
1) Run an a-priori simulation using the APSim module
2) Interpolate E-field values for new coil matrices based on a-priori simulations with se3_interpolator_trees

Step 1 depends on SimNIBS 4.0.0 and the respective implementation of auxiliary dipole method (ADM, Gomez et al. 2021). Once simulations are done, interpolation can be performed independent from SimNIBS in any other Python environment. Example code is shown in "Example_sampling.py". Sampling includes positions as well as rotations. Rotation sampling is based on code provided by Yershova et al. (2010) for Hopf-fibration of SO(3) space of rotations. The quaternion files were created with C++ using the code provided at https://lavalle.pl/software/so3/so3.html. 

For Step 2, we include example data derived from actual motion tracking timecourses. This includes the coil matrices received from neuronavigation (neuronavigation_tracking.npy) as well as the corresponding simulations for each matrix as a ground truth (neuronavigation_simulation.geo).
The files "coil_matrices.txt" and "coil_positions.geo" represent the output generated by APSim. The example code "Example_interpolation.py" shows how to read in these files and how to create the interpolator as well as how to run individual interpolations.

Code was created by Michael Woletz and Sarah Grosshagauer. Parts of the sampling code are based on SimNIBS functions. 

# References
L. J. Gomez, M. Dannhauer, and A. V. Peterchev, ‘Fast computational optimization of TMS coil placement for individualized electric field targeting’, NeuroImage, vol. 228, p. 117696, Mar. 2021, doi: 10.1016/j.neuroimage.2020.117696.
A. Yershova, S. Jain, S. M. LaValle, and J. C. Mitchell, ‘Generating Uniform Incremental Grids on SO(3) Using the Hopf Fibration’, Int. J. Robot. Res., vol. 29, no. 7, pp. 801–812, June 2010, doi: 10.1177/0278364909352700.
